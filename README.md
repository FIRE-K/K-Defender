# K-Defender

## Оглавление

1. Описание проекта
2. Назначение и область применения
3. Ключевая функциональность
4. Архитектура и принципы работы
5. Структура репозитория
6. Быстрый старт
7. Установка и интеграция
8. Конфигурация
9. Сценарии использования
10. Ограничения и модель угроз
11. Расширение и кастомизация
12. Безопасность и юридические аспекты
13. Контакты и авторство

---

## 1. Описание проекта

**K-Defender** — это защитный модуль для **Telegram-ботов**, предназначенный для анализа пользовательского ввода и обнаружения инъекционных атак на уровне сообщений, команд и callback-данных.

На текущем этапе развития проект **ориентирован исключительно на Telegram-экосистему** и используется совместно с библиотеками:

* aiogram,
* telethon.

K-Defender внедряется непосредственно в логику бота и выполняет проверку входных данных **до их обработки**, обращения к базе данных или выполнения команд.

Проект разрабатывается как **учебно-практический и защитный инструмент**, пригодный для:

* демонстрации типовых уязвимостей Telegram-ботов и способов их защиты;
* тестирования и улучшения собственных ботов.

---

## 2. Назначение и область применения

K-Defender предназначен для:

* защиты пользовательского ввода от инъекционных атак;
* демонстрации принципов secure‑coding;
* обучения анализу атак и построению защитных механизмов;
* повышения устойчивости Telegram‑ботов и Python‑сервисов.

Проект **не является коммерческим WAF** и не претендует на абсолютную защиту, а фокусируется на:

* понятности архитектуры;
* расширяемости;
* воспроизводимости атак и защитных сценариев.

---

## 3. Ключевая функциональность

### Поддерживаемые типы атак (Telegram-боты)

* SQL-инъекции (в контексте запросов бота к БД);
* XSS-подобные полезные нагрузки (HTML / Markdown abuse в Telegram);
* Command Injection (при небезопасной обработке команд);
* Telegram-инъекции (некорректная обработка markdown, ссылок, спецсимволов);
* Общие сигнатуры подозрительного ввода.

### Возможности системы

* Сигнатурная проверка пользовательского ввода:
  * текста сообщений (`message.text`);
  * аргументов команд (`/command <payload>`);
  * callback-данных (`callback_query.data`);
* Поддержка формата сигнатур JSON;
* Централизованная функция проверки ввода;
* Получение результата анализа (тип угрозы, сигнатура).

---

## 4. Архитектура и принципы работы

### Общий принцип работы

1. Telegram-бот получает пользовательский ввод (сообщение, команду или callback);
2. Ввод передаётся в модуль K-Defender;
3. Выполняется сигнатурный анализ строки;
4. При совпадении с сигнатурой:
   * определяется тип атаки,
   * формируется результат проверки;
5. Бот отправляет сообщение об некорректном вводе пользователю

### Характер анализа

* Сигнатурный анализ строк;
* Использование регулярных выражений;
* Проверка на характерные payload-последовательности.

---

## 5. Структура репозитория
Ниже приведено дерево каталога (без кеш-файлов __pycache__ и т.д.):
```
K-Defender
├── k-defender.py
├── normalization.py
├── signatures.json
├── state.json
└── str_session.py
```
---

## 6. Быстрый старт

### Запуск Telegram бота K-Defender (@kdefender_bot)

Telegram-бот K-Defender используется как главный компонент проекта.
Бот предназначен для:
* проверки пользовательского ввода на наличие инъекционных атак;
* тестирования сигнатур и логики обнаружения угроз;
* отладки и анализа защитных механизмов.

Есть два способа использовать защиту K-Defender:
1. Использование уже рабочего Telegram бота K-Defender (**@kdefender_bot**):
   * В Телеграмм найти бота;
   * Нажать кнопку "Старт";
   * После этого в боте будут предоставлены дальнейшие инструкции.
2. Запустить бота у себя на устройстве:
   * скачать GitHub репозиторий
     ```bash
     git clone https://github.com/FIRE-K/K-Defender.git
     ```
     или нажать кнопку Code и выбрать опцию `Скачать ZIP/Download ZIP`, после чего распаковать архив в нужном каталоге
   * указать в .env требуемые данные (TOKEN нужно получить у Bot Father, API_ID, API_HASH - https://my.telegram.org/apps)
   * Для получения TELETHON_SESSION нужно запустить файл `str_session.py` (для запуска требуются API_ID, API_HASH в файле .env)
     ```.env
     TOKEN=<...>
     API_ID=<...>
     API_HASH=<...>
     TELETHON_SESSION=<...>
     ```
   * запустить файл `k-defender.py`
   * тоже самое как и в первом пункте (только имя бота будет указанным в Bot Father)

### Установка Python модуля для интеграции защиты

```bash
pip install kdefender-wrapper
```

Краткая документация: https://pypi.org/project/kdefender-wrapper/

Исходный код представлен в файле kdefender_wrapper_local.py (в имени файла указано local для избежания дублирования имени файла и модуля)

### Минимальный пример (Telegram-бот)

```python
import asyncio
from kdefender_wrapper import setup, kdefender_check

await setup(
    bot=bot,
    api_id=API_ID,
    api_hash=API_HASH,
    session=SESSION,
    group_id=GROUP_ID,
    chat_token=CHAT_TOKEN,
    kdefender_id=K_DEFENDER_ID,
)

@kdefender_check()
async def handler(message):
    await message.answer("✅ Message accepted")
```

Пример демонстрирует проверку получаемого сообщения (в данном случае, message).

---

## 7. Установка и интеграция

### Telegram-боты

K-Defender интегрируется напрямую в обработчики Telegram-бота:

* `message.text` — входящие сообщения;
* аргументы команд (`/<command> <data>`);
* `callback_query.data` — inline-кнопки;
* пользовательские формы ввода.

Рекомендуется вызывать K-Defender **перед**:

* запросами к базам данных (тем более, при использовании вводимых пользователем данных);
* обработкой пользовательских команд;
* динамическим формированием ответов с HTML / Markdown.

---

## 8. Конфигурация

### Сигнатуры

Сигнатуры хранятся в формате JSON и содержат:

* тип аттаки;
* список паттернов;
* уровень риска.

Структура:

```json
{
  "CATEGORY": {
    "patterns": [...],
    "risk": <int>
  }
}
```

---

## 9. Сценарии использования

### Защищённый Telegram-бот

Пользователь отправляет сообщение → K-Defender анализирует ввод → бот принимает решение о дальнейших действиях.

### Учебный бот

Используется для демонстрации:

* небезопасной обработки ввода;
* типовых атак на Telegram-ботов;
* последующего внедрения защитных проверок.

### Отладка и аудит

Разработчик тестирует устойчивость бота к вредоносным payload’ам и расширяет сигнатуры.

---

## 10. Ограничения и модель угроз

K-Defender **не решает все задачи безопасности** и имеет следующие ограничения:

* не анализирует бизнес-логику бота;
* не предотвращает ошибки проектирования;
* не защищает от уязвимостей сторонних библиотек;
* не является системой обнаружения вторжений.

K-Defender предназначен для **раннего обнаружения опасного пользовательского ввода** в Telegram-ботах и желательно использовать совместно с:

* параметризованными SQL-запросами;
* корректной обработкой Markdown / HTML;
* логированием и мониторингом.

---

## 11. Расширение и кастомизация

* Добавление собственных сигнатур;
* Интеграция с SIEM;
* Подключение БД для хранения инцидентов;
* Реализация scoring‑системы угроз;
* Расширение форматов анализа;
* Интеграция с административной логикой бота.

---

## 12. Безопасность и юридические аспекты

Проект предназначен **исключительно для легального использования**:

* обучения;
* защиты собственных систем;
* демонстрационных проектов.

Автор не несёт ответственности за неправомерное использование.

---

## 13. Контакты и авторство

**Автор:** Карпов Константин (FIRE‑K)

GitHub: https://github.com/FIRE-K/

Проект разрабатывается как открытый и образовательный.

Если у вас есть идеи, предложения или найденные проблемы — pull request и issues приветствуются.

---

**K‑Defender** — защита начинается с понимания атак.

